---
title: 'SCOTI simulation-seabird Norwegian example'
author: "Based on SCOTI scripts (multiple authors)"
date: "`r format(Sys.time(), '%d %B, %Y')`"
output: html_document
---

```{r, echo=FALSE,warning=FALSE,message=FALSE}
knitr::opts_chunk$set(tidy=TRUE, dpi=150)
library(dplyr)
library(ggplot2)
library(wesanderson)
```

## Parametrization for a seabird example

The current example is based on data from the Reference fleet in Norway (IMR). More information on The Norwegian Reference Fleet can be found [here](https://hdl.handle.net/11250/2685855). In this particular case we consider bycatch of Northern fulmars (*Fulmarus glacialis*) in a sample of the offshore longline fishery where we have high confidence in that the reported numbers are close to actual numbers of bycatch.

It is worth keeping in mind that the observed probabilities of bycatch events and number of individuals bycaught per event could be biased values (e.g., already including an observation error that might might shape those parameters). Parameter values used in the 'base case' and their descriptions are in Table \@ref(tab:params).

```{r echo=FALSE,tab.cap='Parameter values used in simulations.', tab.id='params',  tab.cap.style = "Table Caption"}
params <- read.csv("norway_params.csv", header = TRUE)
colnames(params)[2] <- "Simulation component"
#colnames(params)[4:5] <- c("Base case", "Expansion outside reference fleet")
params |> 
  flextable::flextable() |> 
  flextable::set_table_properties(layout = "autofit") |>
  flextable::theme_vanilla()
```

## {scoti} functions used

This code uses all simulation functions from the original `{scoti}` scripts, except for the `make_fishing_metier()` function, which has been modified to include a "vessel effect" (see below).

```{r,warning=FALSE,message=FALSE,echo=TRUE,results='hide',eval=FALSE}

source("https://raw.githubusercontent.com/dlusseau/scoti/main/estimate_fishing_effort_metier.R")
source("https://raw.githubusercontent.com/dlusseau/scoti/main/heterogeneity_stats_distributions.r")
source("https://raw.githubusercontent.com/dlusseau/scoti/main/make_fishing_year_metier.r")
source("https://raw.githubusercontent.com/dlusseau/scoti/main/monitor_BPUE_metier.R")
```

## Simulating fishery data

We use the `make_fishing_year_metier()` function to simulate the fishery in the case study.

The next parameter controls the mean number of fishing events per boat day. In this case study vessel is the primary sampling unit, and we assume that one day at sea equals one haul (i.e., mean fishing event per boat day is one). The data represent one metier (L4, LLF_DES_0_0_0), so the probability of recording at one metier is set to one.

The next couple of parameters concerns the probability of a bycatch event: The mean number of birds taken given an event, as well as the potential of more extreme events (probability of a large bycatch event as well as the mean number of individuals taken in those events). In the data there are signs of bycatch following a bimodial distribution, in the sense that we have some rare events with a much higher number (N~max~=36) than the estimated mean bycatch (\~2). The probability of a large event, as well as the number of birds captured in these events are however rather uncertain as they are indeed rare events in the data. So, these parameters could be considered a mixture between data driven and more qualitatively driven (based on informal communication with fishers). In the data, there are unexplained variation between vessels in reported bycatch numbers, i.e. a vessel effect of bycatch which might be attributed to a number of different variables in reality (training, mitigation measures, spatio-temporal variation in fishing etc).

```{r,warning=FALSE,message=FALSE,echo=TRUE,results='hide',eval=FALSE}

# Simulate the true state of the fishery
nboat <- 28
mean.fishing.event.boat.day <- 1
p.metier <- 1
p.bycatch <- 0.12 # range is from 0.02 to 0.12
p.large.event <- 0.007
mean.bycatch.event <- 2 # (rounded down from 2.4)
mean.bycatch.large.event <- 36 # max in dataset is 36 
stochastic <- FALSE
BPUE_real <- sum(fishing$nbycatch) / dim(fishing)[1]
vessel.effect <- 0.7
```

## Simulating monitoring

We don't have any actual data to calculate detection probability of individual birds in the catch, but we use a fixed probability [0.7](https://doi.org/10.1371/journal.pone.0220797) based on similar fisheries in the literature. We thus assume that some we don't have any information that this is likely to vary in time or space. The 'refusal rate' is assumed to be zero, as these values represent a reference fleet.

```{r,warning=FALSE,message=FALSE,echo=TRUE,results='hide',eval=FALSE}
# Simulate monitoring
pmonitor <- 1
nsample <- 100 # How many times to run - this is independent of the fishery, it's just how many draws you want to do.
p_monitor_boat <- 3/31 #  n boats that were willing to report seabirds
boat_samp <- TRUE
p_haul_obs <- 1 # should be fixed at 1 per David
detect_prob <- 0.7
refusal_rate <- 0 # ignoring refusal for now
misclassification <- 0
bymetier <- FALSE
p_monitor_metier <- 1
```

## Incorporating a vessel effect

To account for non-independence of repeated sampling by vessels, we introduced additional variation in bycatches across vessels after bycatch observations were generated. This was done by adding random noise to the final estimate with \mu = 0 and \theta defined as an additional parameter in the simulation (named `vessel.effect`). To ensure the additional variation didn't generate negative values, we applied it to log-transformed observations before back-transforming to the original scale.

```{r echo=FALSE}
load('output/vessel_effect_cv_vs_BPUE.rds')

p1 <- bigdf |>
  mutate(vessel.effect.vec = as.factor(vessel.effect.vec)) |>
  ggplot(aes(x=p_monitor_boat.vec.p.,y=BPUE_CV_vec  ,
             color = vessel.effect.vec, group = vessel.effect.vec)) +
  geom_line(lwd=1.2) +
  xlab("Proportion of vessels monitored") +
  ylab("CV of BPUE estimate") +
  scale_color_manual("Vessel effect", values = wes_palette("Rushmore1", n = 5, type = 'discrete')[c(1,3,4,5)] ) +
  theme_classic(base_size = 16)
p1
```

# Spatial and temporal overlap extension

We extended the original `{scoti}` framework to represent a situation where there is spatial variation in the probability of a bycatch event occurring (i.e., bycatch hot spot(s)). The bycatch hot spot(s) can also be switched on and of during a fishing year. The rationality for introducing hotspot areas for  bycatch is based on the spatiotemporal variation in species abundance across areas during a year. Furthermore, as fisheries also are likely to vary in intensity across areas during a year, the framework also have a possibility to vary the fishing effort the range of areas using different shape parameters of the [beta-distribution](https://en.wikipedia.org/wiki/Beta_distribution). 

Specifically, bycatch hot spots can be parameterised as one or more areas (hotspot.area) of a total number of areas (narea), which then will act as a bycatch hot spot with increased probability of bycatch during the specified time period during a year (time.periods.bycatch). This option can be switched on or off with the parameter spatio.temporal.bycatch.trend. The trend in fishing effort is similarly switched on or off with the parameter spatio.temporal.fishery.trend. This allows for control over which areas the vessels in the fleet should target their fishing effort. To do this, two set of shape parameters controlling the shape of two different beta distributions should be defined. First, a general pattern of fishing activity across the total number of areas should be defined with the parameter spatial.effort.skewness.general (for example if the general pattern of the vessel is a uniform distribution of vessels across areas we use α = β = 1). Then one could shift this distribution using other values of α and β in the parameter spatial.effort.skewness.special, if there are specific time periods during the year (defined in time.periods.fishery) that where the fishery is more focused in some areas. 
```{r,warning=FALSE,message=FALSE,echo=TRUE,results='hide',eval=FALSE}

#Tuning of bycatch variability
spatio.temporal.bycatch.trend <- TRUE #switch that turn on (TRUE) or off (FALSE) bycatch variability
narea <- 10 # Defines the total number of areas in the focal fishery, integr
hotspot.area = 10 #Defines a one or more areas between 1 and narea to  
time.periods.bycatch <- 32:60 #Time periods of the year, in days, hotspot should be active. Can be multiple time periods 

#Tuning of fishery 

spatio.temporal.fishery.trend <- TRUE # this turns on or off the other spatial/temporal 
spatial.effort.skewness.general <- c(1,1)
spatial.effort.skewness.special <- c(1.7,0.3)
time.periods.fishery <- 32:60
 

```

# Comparison to a dedicated observer programme

We simulated a hypothetical observer programme to evaluate the sampling effort needed to improve the performance of seabird bycatch estimation relative to current estimates that use Norwegian Reference Fleet data.

An observer programme would sample more vessels but fewer fishing operations. However, a refusal rate would be larger yet unknown, so we explored a wide range of values. The detection probability would increase given that the observer would have a single task.

```{r echo=FALSE,warning=FALSE}
load('output/observer_prog_cv_vs_BPUE_5000.rds')

p2 <- bigdf %>%
  mutate(refusal_rate.vec = as.factor(refusal_rate.vec)) %>%
  ggplot(aes(x=p_monitor_boat.vec.p.,y=BPUE_CV_vec  ,
             color = refusal_rate.vec, group = refusal_rate.vec)) +
  geom_line(lwd=1.2) +
  xlab("Proportion of vessels monitored") +
  ylab("CV of BPUE estimate") +
  scale_color_manual("Refusal rate", values = wes_palette("FantasticFox1",n = 4, type = 'discrete')) +
  theme_classic(base_size = 16)
p2
```

